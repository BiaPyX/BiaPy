name: Bump conda-forge feedstock

on:
  workflow_run:
    workflows: ["Upload BiaPy to PyPI"]
    types: [completed]
  workflow_dispatch: {}  # manual test runs

permissions:
  contents: read
  pull-requests: write

env:
  PACKAGE_NAME: biapy
  GH_TOKEN: ${{ secrets.CF_GH_TOKEN }}
  FEEDSTOCK_FORK: ${{ secrets.CF_FEEDSTOCK_FORK }}

jobs:
  bump-feedstock:
    # Only run after the PyPI workflow succeeded for a release,
    # or when manually triggered via workflow_dispatch.
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'release') || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Check out this repo (to read your meta.yaml)
        uses: actions/checkout@v4

      - name: Determine version from release tag (or fall back to PyPI latest)
        id: ver
        shell: bash
        run: |
          RAW_TAG="${{ github.event.workflow_run.head_branch }}"
          if [ -n "$RAW_TAG" ]; then
            VERSION="${RAW_TAG#v}"
          else
            VERSION="$(python -c "import json,urllib.request;print(json.load(urllib.request.urlopen('https://pypi.org/pypi/biapy/json'))['info']['version'])")"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Fetch PyPI sdist URL and SHA256
        id: sdist
        shell: bash
        env:
          VERSION: ${{ steps.ver.outputs.version }}
          PACKAGE_NAME: ${{ env.PACKAGE_NAME }}
        run: |
          PYPI_JSON="https://pypi.org/pypi/${PACKAGE_NAME}/${VERSION}/json"
          OUT=$(python -c "import json,urllib.request,hashlib,os; d=json.load(urllib.request.urlopen('${PYPI_JSON}')); sd=[u for u in d['urls'] if u.get('packagetype')=='sdist']; u=sd[0]['url'] if sd else (_ for _ in ()).throw(SystemExit(1)); h=hashlib.sha256(urllib.request.urlopen(u).read()).hexdigest(); print(u); print(h)")
          SDIST_URL="$(echo "$OUT" | sed -n '1p')"
          SDIST_SHA256="$(echo "$OUT" | sed -n '2p')"
          {
            echo "sdist_url=$SDIST_URL"
            echo "sha256=$SDIST_SHA256"
          } >> "$GITHUB_OUTPUT"

      - name: Set up conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          use-mamba: true
          auto-activate-base: true
          channels: conda-forge

      - name: Install conda-smithy toolchain
        run: mamba install -y python>=3.10 conda-smithy ruamel.yaml

      - name: Authenticate gh CLI (use your PAT)
        run: gh auth status

      - name: Clone your feedstock fork
        run: |
          test -n "$FEEDSTOCK_FORK"
          gh repo clone "$FEEDSTOCK_FORK" feedstock
          cd feedstock
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Copy your meta.yaml into the feedstock
        working-directory: feedstock
        run: |
          cp ../biapy/utils/env/conda_forge_meta.yaml recipe/meta.yaml
          git add recipe/meta.yaml
          git commit -m "Import project's conda_forge_meta.yaml as recipe/meta.yaml"

      - name: Create bump branch and update version + sha256
        working-directory: feedstock
        env:
          VERSION: ${{ steps.ver.outputs.version }}
          SDIST_SHA256: ${{ steps.sdist.outputs.sha256 }}
        shell: bash
        run: |
          BRANCH="bump-v$VERSION"
          git switch -c "$BRANCH"

          # Update version Jinja line
          sed -E -i 's/{%[[:space:]]*set[[:space:]]+version[[:space:]]*=[[:space:]]*"[^"]+"[[:space:]]*%}/{% set version = "'"$VERSION"'" %}/' recipe/meta.yaml

          # Update sha256 under source
          sed -E -i 's/(sha256:[[:space:]]*)([0-9a-fA-F]+)/\1'"$SDIST_SHA256"'/' recipe/meta.yaml

          git add recipe/meta.yaml
          git commit -m "Bump to v$VERSION (update version and sha256)"

      - name: (Optional) conda-smithy rerender
        working-directory: feedstock
        run: |
          conda-smithy rerender -c auto || true
          if ! git diff --quiet; then
            git add .
            git commit -m "conda-smithy rerender"
          fi

      - name: Push branch to your fork
        working-directory: feedstock
        run: git push --set-upstream origin HEAD

      - name: Open PR to conda-forge feedstock
        working-directory: feedstock
        env:
          VERSION: ${{ steps.ver.outputs.version }}
        run: |
          TITLE="biapy v$VERSION"
          BODY="Automated bump to $VERSION after successful PyPI upload.\n\n- Recipe copied from project: \`biapy/utils/env/conda_forge_meta.yaml\`\n- Version and sha256 updated from PyPI sdist."
          OWNER="${FEEDSTOCK_FORK%%/*}"
          BRANCH="bump-v$VERSION"
          gh pr create \
            --repo conda-forge/biapy-feedstock \
            --title "$TITLE" \
            --body "$BODY" \
            --head "${OWNER}:${BRANCH}" \
            --base "main"
