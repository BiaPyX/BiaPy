

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>generators.data_3D_generators &mdash; EM Image Segmentation  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> EM Image Segmentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Quick start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">Step 0: Prepare environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html#step-1-data-preparation">Step 1: Data preparation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html#step-1-choose-a-template">Step 1: Choose a template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html#step-3-run-the-code">Step 3: Run the code</a></li>
</ul>
<p class="caption"><span class="caption-text">Manuscripts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mitochondria.html">Mitochondria segmentation</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data_2d_manipulation.html">2D Data manipulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_3d_manipulation.html">3D Data manipulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generators.html">Generators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networks.html">Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../util.html">Util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../post_processing.html">Post processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../grad_cam.html">Grad-CAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../adabound.html">Adabound</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">EM Image Segmentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>generators.data_3D_generators</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for generators.data_3D_generators</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imread</span>
<span class="kn">from</span> <span class="nn">util</span> <span class="kn">import</span> <span class="n">img_to_onehot_encoding</span> 
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">rotate</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.interpolation</span> <span class="kn">import</span> <span class="n">shift</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">from</span> <span class="nn">imgaug</span> <span class="kn">import</span> <span class="n">augmenters</span> <span class="k">as</span> <span class="n">iaa</span>
<span class="kn">from</span> <span class="nn">imgaug.augmentables.segmaps</span> <span class="kn">import</span> <span class="n">SegmentationMapsOnImage</span>
<span class="kn">import</span> <span class="nn">imgaug</span> <span class="k">as</span> <span class="nn">ia</span>
<span class="kn">from</span> <span class="nn">imgaug</span> <span class="kn">import</span> <span class="n">parameters</span> <span class="k">as</span> <span class="n">iap</span>
<span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imsave</span>                                                   


<div class="viewcode-block" id="VoxelDataGenerator"><a class="viewcode-back" href="../../3d_generator.html#generators.data_3D_generators.VoxelDataGenerator">[docs]</a><span class="k">class</span> <span class="nc">VoxelDataGenerator</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Custom ImageDataGenerator for 3D images.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">random_subvolumes_in_DA</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subvol_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">shuffle_each_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">da</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">shift_range</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">elastic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">g_blur</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gamma_contrast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_classes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prob_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_data_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ImageDataGenerator constructor. Based on transformations from </span>
<span class="sd">           https://github.com/aleju/imgaug.</span>
<span class="sd">                                                                                </span>
<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           X : Numpy 5D array</span>
<span class="sd">               Data. E.g. ``(num_of_images, x, y, z, channels)``.</span>

<span class="sd">           Y : Numpy 5D array</span>
<span class="sd">               Mask data. E.g. ``(num_of_images, x, y, z, channels)``.</span>

<span class="sd">           random_subvolumes_in_DA : bool, optional</span>
<span class="sd">               To extract random subvolumes from the given data. If not, the </span>
<span class="sd">               data must be 5D and is assumed that the subvolumes are prepared. </span>
<span class="sd">    </span>
<span class="sd">           subvol_shape : 4D tuple of ints, optional</span>
<span class="sd">               Shape of the subvolume to be extracted randomly from the data. </span>
<span class="sd">               E. g. ``(x, y, z, channels)``.</span>
<span class="sd">            </span>
<span class="sd">           seed : int, optional</span>
<span class="sd">               Seed for random functions.</span>
<span class="sd">                </span>
<span class="sd">           shuffle_each_epoch : bool, optional</span>
<span class="sd">               To shuffle data after each epoch.</span>

<span class="sd">           batch_size : int, optional</span>
<span class="sd">               Size of the batches.</span>
<span class="sd">            </span>
<span class="sd">           da : bool, optional</span>
<span class="sd">               To activate the data augmentation.</span>
<span class="sd">            </span>
<span class="sd">           shift_range : float, optional</span>
<span class="sd">               Range to make a shift. It must be a number between ``0`` and ``1``. </span>

<span class="sd">           flip : bool, optional</span>
<span class="sd">               To activate flips.</span>
<span class="sd">        </span>
<span class="sd">           rotation : bool, optional</span>
<span class="sd">               To make ``[-180, 180]`` degree range rotations.</span>

<span class="sd">           elastic : bool, optional</span>
<span class="sd">               To make elastic deformations.</span>
<span class="sd">            </span>
<span class="sd">           g_blur : bool, optional</span>
<span class="sd">               To insert gaussian blur on the images.</span>

<span class="sd">           gamma_contrast : bool, optional</span>
<span class="sd">               To insert gamma constrast changes on images. </span>

<span class="sd">           n_classes : int, optional</span>
<span class="sd">               Number of classes. If ``&gt; 1`` one-hot encoding will be done on </span>
<span class="sd">               the ground truth.</span>

<span class="sd">           out_number : int, optional                                               </span>
<span class="sd">               Number of output returned by the network. Used to produce same </span>
<span class="sd">               number of ground truth data on each batch. </span>

<span class="sd">           val : bool, optional</span>
<span class="sd">               Advice the generator that the volumes will be used to validate</span>
<span class="sd">               the model to not make random crops (as the validation data must</span>
<span class="sd">               be the same on each epoch). Valid when ``random_subvolumes_in_DA`` </span>
<span class="sd">               is set.</span>

<span class="sd">           prob_map : 5D Numpy array, optional</span>
<span class="sd">               Probability map used to make random crops when</span>
<span class="sd">               ``random_subvolumes_in_DA`` is set.</span>
<span class="sd">            </span>
<span class="sd">           extra_data_factor : int, optional</span>
<span class="sd">               Factor to multiply the batches yielded in a epoch. It acts as if</span>
<span class="sd">               ``X`` and ``Y``` where concatenated ``extra_data_factor`` times.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">5</span> <span class="ow">or</span> <span class="n">Y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;X and Y must be a 5D Numpy array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>                                          
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The shape of X and Y must be the same. </span><span class="si">{}</span><span class="s2"> != </span><span class="si">{}</span><span class="s2">&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">4</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">random_subvolumes_in_DA</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subvol_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;subvol_shape&#39; must be provided when &quot;</span>
                                 <span class="s2">&quot;&#39;random_subvolumes_in_DA is enabled&quot;</span><span class="p">)</span>         
            <span class="k">if</span> <span class="n">subvol_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">subvol_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> \
               <span class="n">subvol_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Given &#39;subvol_shape&#39; is bigger than the data &quot;</span>
                                 <span class="s2">&quot;provided&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="n">X</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="n">Y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="n">n_classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_number</span> <span class="o">=</span> <span class="n">out_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">random_subvolumes_in_DA</span> <span class="o">=</span> <span class="n">random_subvolumes_in_DA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_each_epoch</span> <span class="o">=</span> <span class="n">shuffle_each_epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">da</span> <span class="o">=</span> <span class="n">da</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">extra_data_factor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_data_factor</span> <span class="o">=</span> <span class="n">extra_data_factor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">o_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">o_indexes</span><span class="p">]</span><span class="o">*</span><span class="n">extra_data_factor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_data_factor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_map</span> <span class="o">=</span> <span class="n">prob_map</span>
        <span class="k">if</span> <span class="n">random_subvolumes_in_DA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">subvol_shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flip</span> <span class="o">=</span> <span class="n">flip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_range</span> <span class="o">=</span> <span class="n">shift_range</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">total_batches_seen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgaug</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">da_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans_made</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">elastic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">da_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iaa</span><span class="o">.</span><span class="n">Sometimes</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">iaa</span><span class="o">.</span><span class="n">ElasticTransformation</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">250</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;reflect&quot;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans_made</span> <span class="o">+=</span> <span class="s1">&#39;_elastic&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgaug</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">g_blur</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">da_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iaa</span><span class="o">.</span><span class="n">Sometimes</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">iaa</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">))))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans_made</span> <span class="o">+=</span> <span class="s1">&#39;_gblur&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgaug</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">gamma_contrast</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">da_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iaa</span><span class="o">.</span><span class="n">Sometimes</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">iaa</span><span class="o">.</span><span class="n">GammaContrast</span><span class="p">((</span><span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">))))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans_made</span> <span class="o">+=</span> <span class="s1">&#39;_gcontrast&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgaug</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">iaa</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">da_options</span><span class="p">)</span>
        <span class="n">ia</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Defines the length of the generator&quot;&quot;&quot;</span>
    
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_data_factor</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__draw_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">grid_width</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw grid of the specified size on an image. </span>
<span class="sd">           </span>
<span class="sd">           Parameters</span>
<span class="sd">           ----------                                                                </span>
<span class="sd">           im : 4D Numpy array</span>
<span class="sd">               Image to be modified. E. g. ``(x, y, z, channels)``</span>
<span class="sd">                </span>
<span class="sd">           grid_width : int, optional</span>
<span class="sd">               Grid&#39;s width. </span>

<span class="sd">           v : int, optional</span>
<span class="sd">               Value to create the grid with.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grid_width</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">im</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">grid_width</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">im</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">im</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generation of one batch of data. </span>
<span class="sd">           </span>
<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           index : int</span>
<span class="sd">               Batch index counter.</span>
<span class="sd">            </span>
<span class="sd">           Returns</span>
<span class="sd">           -------  </span>
<span class="sd">           batch_x : 5D Numpy array</span>
<span class="sd">               Corresponding X elements of the batch.</span>
<span class="sd">               E.g. ``(batch_size_value, x, y, z, channels)``.</span>

<span class="sd">           batch_y : 5D Numpy array</span>
<span class="sd">               Corresponding Y elements of the batch.</span>
<span class="sd">               E.g. ``(batch_size_value, x, y, z, channels)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">index</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="n">batch_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">),</span> <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">batch_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">),</span> <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,),</span> 
                           <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)),</span> <span class="n">indexes</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_subvolumes_in_DA</span><span class="p">:</span>
                <span class="n">batch_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">batch_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_3D_crop</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> 
                    <span class="n">vol_prob</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">batch_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">da</span><span class="p">:</span>
                <span class="n">batch_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">batch_y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_transform</span><span class="p">(</span><span class="n">batch_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">batch_y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">):</span>
            <span class="n">batch_y_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">),</span> <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span><span class="p">,))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)):</span>
                <span class="n">batch_y_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img_to_onehot_encoding</span><span class="p">(</span><span class="n">batch_y</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

            <span class="n">batch_y</span> <span class="o">=</span> <span class="n">batch_y_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">total_batches_seen</span> <span class="o">+=</span> <span class="mi">1</span>
                                                                                        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>                                                
            <span class="k">return</span> <span class="n">batch_x</span><span class="p">,</span> <span class="n">batch_y</span>                                             
        <span class="k">else</span><span class="p">:</span>                                                                   
            <span class="k">return</span> <span class="p">([</span><span class="n">batch_x</span><span class="p">],</span> <span class="p">[</span><span class="n">batch_y</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">out_number</span><span class="p">)</span>

<div class="viewcode-block" id="VoxelDataGenerator.on_epoch_end"><a class="viewcode-back" href="../../3d_generator.html#generators.data_3D_generators.VoxelDataGenerator.on_epoch_end">[docs]</a>    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates indexes after each epoch.&quot;&quot;&quot;</span>

        <span class="n">ia</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_batches_seen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o_indexes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_each_epoch</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_batches_seen</span><span class="p">)</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span></div>

<div class="viewcode-block" id="VoxelDataGenerator.apply_transform"><a class="viewcode-back" href="../../3d_generator.html#generators.data_3D_generators.VoxelDataGenerator.apply_transform">[docs]</a>    <span class="k">def</span> <span class="nf">apply_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform the input image and its mask at the same time with one of</span>
<span class="sd">           the selected choices based on a probability.</span>
<span class="sd">    </span>
<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           image : 4D Numpy array</span>
<span class="sd">               Image to transform. E.g. ``(x, y, z, channels)``.</span>

<span class="sd">           mask : 4D Numpy array</span>
<span class="sd">               Mask to transform. E.g. ``(x, y, z, channels)``.</span>
<span class="sd">    </span>
<span class="sd">           Returns</span>
<span class="sd">           -------</span>
<span class="sd">           trans_image : 4D Numpy array</span>
<span class="sd">               Transformed image. E.g. ``(x, y, z, channels)``.</span>

<span class="sd">           trans_mask : 4D Numpy array</span>
<span class="sd">               Transformed image mask. E.g. ``(x, y, z, channels)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trans_made</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># IMG</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_image</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">l_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        <span class="c1"># MASK</span>
        <span class="n">m_channel</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_mask</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">l_mask</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
        
        <span class="c1"># [0-0.25): x axis flip</span>
        <span class="c1"># [0.25-0.5): y axis flip</span>
        <span class="c1"># [0.5-0.75): z axis flip</span>
        <span class="c1"># [0.75-1]: nothing</span>
        <span class="c1">#</span>
        <span class="c1"># x axis flip</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip</span> <span class="ow">and</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>   
            <span class="c1"># IMG</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c1"># MASK</span>
            <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">trans_made</span> <span class="o">=</span> <span class="s1">&#39;_xf&#39;</span>
        <span class="c1"># y axis flip</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip</span> <span class="ow">and</span> <span class="mf">0.25</span> <span class="o">&lt;=</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="c1"># IMG</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>                                                        
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                
                    <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>                         
            <span class="c1"># MASK</span>
            <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">trans_made</span> <span class="o">=</span> <span class="s1">&#39;_yf&#39;</span>
        <span class="c1"># z axis flip</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip</span> <span class="ow">and</span> <span class="mf">0.5</span> <span class="o">&lt;=</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">:</span>
            <span class="c1"># IMG</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>                                                        
                <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>       
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                
                    <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>                         
            <span class="c1"># MASK</span>
            <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">trans_made</span> <span class="o">=</span> <span class="s1">&#39;_zf&#39;</span>
       
        <span class="c1"># [0-0.25): 90 rotation</span>
        <span class="c1"># [0.25-0.5): 180 rotation</span>
        <span class="c1"># [0.5-0.75): 270 rotation</span>
        <span class="c1"># [0.75-1]: nothing</span>
        <span class="c1"># 90 rotation on x axis</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="ow">and</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>   
            <span class="c1"># IMG</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>    
                               <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                 
                    <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                                        <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># MASK</span>
            <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                          <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                          <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">trans_made</span> <span class="o">+=</span> <span class="s1">&#39;_yr90&#39;</span>
        <span class="c1"># 180 rotation on x axis</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="ow">and</span> <span class="mf">0.25</span> <span class="o">&lt;=</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="c1"># IMG</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                               <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                
                    <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                                        <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>                          
            <span class="c1"># MASK</span>
            <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                          <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                          <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">trans_made</span> <span class="o">+=</span> <span class="s1">&#39;_yr180&#39;</span>
        <span class="c1"># 270 rotation on x axis</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation</span> <span class="ow">and</span> <span class="mf">0.5</span> <span class="o">&lt;=</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">:</span>
            <span class="c1"># IMG</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                               <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                
                    <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                                        <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>                          
            <span class="c1"># MASK</span>
            <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                          <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rotate</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">,</span>
                          <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">trans_made</span> <span class="o">+=</span> <span class="s1">&#39;_yr270&#39;</span>

        <span class="c1"># [0-0.25): x axis shift </span>
        <span class="c1"># [0.25-0.5): y axis shift</span>
        <span class="c1"># [0.5-0.75): z axis shift </span>
        <span class="c1"># [0.75-1]: nothing</span>
        <span class="c1">#</span>
        <span class="c1"># x axis shift </span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_range</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span>
            <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_range</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">trans_made</span> <span class="o">+=</span> <span class="s1">&#39;_xs&#39;</span> 
        <span class="c1"># y axis shift </span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_range</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="mf">0.25</span> <span class="o">&lt;=</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>                   
            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span>                                          
            <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_range</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>          
            <span class="n">trans_made</span> <span class="o">+=</span> <span class="s1">&#39;_ys&#39;</span>
        <span class="c1"># z axis shift</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_range</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="mf">0.5</span> <span class="o">&lt;=</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">:</span>                   
            <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">ndim</span>                                          
            <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shift_range</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>          
            <span class="n">trans_made</span> <span class="o">+=</span> <span class="s1">&#39;_zs&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_range</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prob</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">:</span>
            <span class="c1"># IMG                                                               </span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>                                                    
                <span class="n">shift</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>                           
            <span class="k">else</span><span class="p">:</span>                                                               
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                
                    <span class="n">shift</span><span class="p">(</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">shift</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>                  
            <span class="c1"># MASK                                                              </span>
            <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>                                             
                <span class="n">shift</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>                            
            <span class="k">else</span><span class="p">:</span>                                                               
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                 
                    <span class="n">shift</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">shift</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgaug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
                <span class="n">segmap</span> <span class="o">=</span> <span class="n">SegmentationMapsOnImage</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">image</span><span class="p">,</span> <span class="n">vol_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">segmentation_maps</span><span class="o">=</span><span class="n">segmap</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">vol_mask</span><span class="o">.</span><span class="n">get_arr</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                             
                    <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">to_deterministic</span><span class="p">()</span>
                    <span class="n">segmap</span> <span class="o">=</span> <span class="n">SegmentationMapsOnImage</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                              
                        <span class="n">image</span><span class="p">,</span> <span class="n">vol_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">segmentation_maps</span><span class="o">=</span><span class="n">segmap</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>                                                   
                        <span class="n">_</span><span class="p">,</span> <span class="n">vol_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">segmentation_maps</span><span class="o">=</span><span class="n">segmap</span><span class="p">)</span>
                    <span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol_mask</span><span class="o">.</span><span class="n">get_arr</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">segmap</span> <span class="o">=</span> <span class="n">SegmentationMapsOnImage</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                 
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                                  
                        <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vol_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">segmentation_maps</span><span class="o">=</span><span class="n">segmap</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>                                                       
                        <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">vol_mask</span><span class="o">.</span><span class="n">get_arr</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                             
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_mask</span><span class="p">):</span>
                        <span class="n">segmap</span> <span class="o">=</span> <span class="n">SegmentationMapsOnImage</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                    <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vol_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">segmentation_maps</span><span class="o">=</span><span class="n">segmap</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_mask</span><span class="p">):</span>
                        <span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol_mask</span><span class="o">.</span><span class="n">get_arr</span><span class="p">()</span>
                
                <span class="c1"># Apply transformations to the rest of the masks (if any)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_image</span><span class="p">):</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_mask</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_image</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">to_deterministic</span><span class="p">()</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_image</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
                        <span class="n">segmap</span> <span class="o">=</span> <span class="n">SegmentationMapsOnImage</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="n">l_mask</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">vol_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">l_image</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">segmentation_maps</span><span class="o">=</span><span class="n">segmap</span><span class="p">)</span>
                    <span class="n">l_mask</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol_mask</span><span class="o">.</span><span class="n">get_arr</span><span class="p">()</span> 

            <span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">trans_made</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans_made</span>
        
        <span class="k">if</span> <span class="n">trans_made</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">trans_made</span> <span class="o">=</span> <span class="s1">&#39;_none&#39;</span>

        <span class="c1"># IMG</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rgb</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                     
                    <span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">l_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">l_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># MASK</span>
        <span class="k">if</span> <span class="n">m_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                                 
                    <span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">l_mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>                   
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">l_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">trans_made</span></div>

<div class="viewcode-block" id="VoxelDataGenerator.get_transformed_samples"><a class="viewcode-back" href="../../3d_generator.html#generators.data_3D_generators.VoxelDataGenerator.get_transformed_samples">[docs]</a>    <span class="k">def</span> <span class="nf">get_transformed_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_examples</span><span class="p">,</span> <span class="n">random_images</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                <span class="n">save_to_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="s1">&#39;aug_3d&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply selected transformations to a defined number of images from</span>
<span class="sd">           the dataset. </span>
<span class="sd">            </span>
<span class="sd">           Parameters</span>
<span class="sd">           ----------</span>
<span class="sd">           num_examples : int</span>
<span class="sd">               Number of examples to generate.</span>
<span class="sd">            </span>
<span class="sd">           random_images : bool, optional</span>
<span class="sd">               Randomly select images from the dataset. If False the examples</span>
<span class="sd">               will be generated from the start of the dataset. </span>

<span class="sd">           save_to_dir : bool, optional</span>
<span class="sd">               Save the images generated. The purpose of this variable is to</span>
<span class="sd">               check the images generated by data augmentation.</span>

<span class="sd">           out_dir : str, optional</span>
<span class="sd">               Name of the folder where the examples will be stored. </span>

<span class="sd">           train : bool, optional</span>
<span class="sd">               To avoid drawing a grid on the generated images. This should be</span>
<span class="sd">               set when the samples will be used for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>    

        <span class="k">if</span> <span class="n">random_images</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">num_examples</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>   
            <span class="n">num_examples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: More samples requested than the ones available. &quot;</span>
                  <span class="s2">&quot;&#39;num_examples&#39; fixed to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_examples</span><span class="p">))</span>
            
        <span class="n">sample_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_examples</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">sample_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_examples</span><span class="p">,</span> <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">,),</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="c1"># Generate the examples </span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;0) Creating samples of data augmentation . . .&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_examples</span><span class="p">)):</span>
            <span class="n">ia</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">random_images</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_subvolumes_in_DA</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_subvolumes_in_DA</span><span class="p">:</span>
                <span class="n">vol</span><span class="p">,</span> <span class="n">vol_mask</span><span class="p">,</span> <span class="n">ox</span><span class="p">,</span> <span class="n">oy</span><span class="p">,</span> <span class="n">oz</span><span class="p">,</span>\
                <span class="n">s_x</span><span class="p">,</span> <span class="n">s_y</span><span class="p">,</span> <span class="n">s_z</span> <span class="o">=</span> <span class="n">random_3D_crop</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">,</span>
                    <span class="n">draw_prob_map_points</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">vol_prob</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prob_map</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
                <span class="n">vol_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">da</span><span class="p">:</span>
                <span class="n">sample_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span>
                <span class="n">sample_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol_mask</span>
                <span class="n">t_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">train</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__draw_grid</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__draw_grid</span><span class="p">(</span><span class="n">vol_mask</span><span class="p">)</span>

                <span class="n">sample_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sample_y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t_str</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">apply_transform</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">vol_mask</span><span class="p">)</span>

            <span class="c1"># Save transformed 3D volumes </span>
            <span class="k">if</span> <span class="n">save_to_dir</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># Original image/mask</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;orig_x_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">+</span><span class="n">t_str</span><span class="o">+</span><span class="s1">&#39;.tiff&#39;</span><span class="p">)</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__draw_grid</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">imsave</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">imagej</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="s1">&#39;ZCYXS&#39;</span><span class="p">})</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;orig_y_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">+</span><span class="n">t_str</span><span class="o">+</span><span class="s1">&#39;.tiff&#39;</span><span class="p">)</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__draw_grid</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">imsave</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">imagej</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="s1">&#39;ZCYXS&#39;</span><span class="p">})</span>
                <span class="c1"># Transformed</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;x_aug_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">+</span><span class="n">t_str</span><span class="o">+</span><span class="s1">&#39;.tiff&#39;</span><span class="p">)</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sample_x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">imsave</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">imagej</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="s1">&#39;ZCYXS&#39;</span><span class="p">})</span>
                <span class="c1"># Mask</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s2">&quot;y_aug_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">+</span><span class="n">t_str</span><span class="o">+</span><span class="s1">&#39;.tiff&#39;</span><span class="p">)</span>
                <span class="n">aux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sample_y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">imsave</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">aux</span><span class="p">,</span> <span class="n">imagej</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;axes&#39;</span><span class="p">:</span> <span class="s1">&#39;ZCYXS&#39;</span><span class="p">})</span>

                <span class="c1"># Save the original images with a red point and a blue square </span>
                <span class="c1"># that represents the point selected with the probability map </span>
                <span class="c1"># and the random volume extracted from the original data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_subvolumes_in_DA</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rc_out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;rd_crop&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">rc_out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The selected point on the random crop was [</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">]&quot;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ox</span><span class="p">,</span><span class="n">oy</span><span class="p">,</span><span class="n">oz</span><span class="p">))</span>

                    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">pos</span><span class="p">,:,:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span> 
                        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>                                                  
                        <span class="n">px</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>                                                          
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">[</span><span class="n">pos</span><span class="p">,:,:,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
                        <span class="n">py</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                       
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">oz</span><span class="p">:</span>
                            <span class="c1"># Paint the selected point in red</span>
                            <span class="n">p_size</span><span class="o">=</span><span class="mi">6</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">oy</span><span class="o">-</span><span class="n">p_size</span><span class="p">,</span><span class="n">oy</span><span class="o">+</span><span class="n">p_size</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ox</span><span class="o">-</span><span class="n">p_size</span><span class="p">,</span><span class="n">ox</span><span class="o">+</span><span class="n">p_size</span><span class="p">):</span> 
                                    <span class="k">if</span> <span class="n">col</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> \
                                       <span class="n">row</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                       <span class="n">px</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
                                       <span class="n">py</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
                   
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">s_z</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s_z</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> 
                            <span class="c1"># Paint a blue square that represents the crop made </span>
                            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_x</span><span class="p">,</span> <span class="n">s_x</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="n">px</span><span class="p">[</span><span class="n">s_y</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                                <span class="n">px</span><span class="p">[</span><span class="n">s_y</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                                <span class="n">py</span><span class="p">[</span><span class="n">s_y</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                                <span class="n">py</span><span class="p">[</span><span class="n">s_y</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_y</span><span class="p">,</span> <span class="n">s_y</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>                    
                                <span class="n">px</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">s_x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                                <span class="n">px</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">s_x</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                                <span class="n">py</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">s_x</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                                <span class="n">py</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">s_x</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                         
                        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                    <span class="n">rc_out_dir</span><span class="p">,</span><span class="s1">&#39;rc_x_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">))</span>
                        <span class="n">mask</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                      <span class="n">rc_out_dir</span><span class="p">,</span><span class="s1">&#39;rc_y_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">))</span>          
        <span class="k">return</span> <span class="n">sample_x</span><span class="p">,</span> <span class="n">sample_y</span></div></div>


<div class="viewcode-block" id="random_3D_crop"><a class="viewcode-back" href="../../3d_generator.html#generators.data_3D_generators.random_3D_crop">[docs]</a><span class="k">def</span> <span class="nf">random_3D_crop</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span> <span class="n">vol_mask</span><span class="p">,</span> <span class="n">random_crop_size</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vol_prob</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">weights_on_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weight_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">draw_prob_map_points</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Random 3D crop &quot;&quot;&quot;</span>

    <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">deep</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">random_crop_size</span>
    <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ox</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">oy</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">oz</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vol_prob</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">vol_prob</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> 
            
            <span class="c1"># Generate the random coordinates based on the distribution</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">vol_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">prob</span><span class="p">)</span>
            <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">vol_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">oz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">oy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            
            <span class="c1"># Adjust the coordinates to be the origin of the crop and control to</span>
            <span class="c1"># not be out of the volume</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">random_crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">x</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_crop_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">random_crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_crop_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_crop_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">z</span> <span class="o">&gt;</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_crop_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">vol</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">random_crop_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_crop_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ox</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">oy</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">oz</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rows</span> <span class="o">-</span> <span class="n">dx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>                                
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cols</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">deep</span> <span class="o">-</span> <span class="n">dz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">draw_prob_map_points</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vol</span><span class="p">[</span><span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="p">),</span> <span class="n">y</span><span class="p">:(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="p">),</span> <span class="n">z</span><span class="p">:(</span><span class="n">z</span><span class="o">+</span><span class="n">dz</span><span class="p">),</span> <span class="p">:],</span> \
               <span class="n">vol_mask</span><span class="p">[</span><span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="p">),</span> <span class="n">y</span><span class="p">:(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="p">),</span> <span class="n">z</span><span class="p">:(</span><span class="n">z</span><span class="o">+</span><span class="n">dz</span><span class="p">),</span> <span class="p">:],</span> <span class="n">ox</span><span class="p">,</span> <span class="n">oy</span><span class="p">,</span> <span class="n">oz</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">weights_on_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vol</span><span class="p">[</span><span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="p">),</span> <span class="n">y</span><span class="p">:(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="p">),</span> <span class="n">z</span><span class="p">:(</span><span class="n">z</span><span class="o">+</span><span class="n">dz</span><span class="p">),</span> <span class="p">:],</span> \
                   <span class="n">vol_mask</span><span class="p">[</span><span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="p">),</span> <span class="n">y</span><span class="p">:(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="p">),</span> <span class="n">z</span><span class="p">:(</span><span class="n">z</span><span class="o">+</span><span class="n">dz</span><span class="p">),</span> <span class="p">:],</span>\
                   <span class="n">weight_map</span><span class="p">[</span><span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="p">),</span> <span class="n">y</span><span class="p">:(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="p">),</span> <span class="n">z</span><span class="p">:(</span><span class="n">z</span><span class="o">+</span><span class="n">dz</span><span class="p">),</span> <span class="p">:]</span>         
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vol</span><span class="p">[</span><span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="p">),</span> <span class="n">y</span><span class="p">:(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="p">),</span> <span class="n">z</span><span class="p">:(</span><span class="n">z</span><span class="o">+</span><span class="n">dz</span><span class="p">),</span> <span class="p">:],</span> \
                   <span class="n">vol_mask</span><span class="p">[</span><span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">+</span><span class="n">dx</span><span class="p">),</span> <span class="n">y</span><span class="p">:(</span><span class="n">y</span><span class="o">+</span><span class="n">dy</span><span class="p">),</span> <span class="n">z</span><span class="p">:(</span><span class="n">z</span><span class="o">+</span><span class="n">dz</span><span class="p">),</span> <span class="p">:]</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Daniel Franco

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>